<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix | Segmented Seat Matrix</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon"
        href="https://raw.githubusercontent.com/nishatrhythm/Bangladesh-Railway-Train-and-Fare-List-with-Route-Map/main/images/bangladesh-railway.png">
</head>

<body>
    <div class="matrix-container">
        <h1><i class="fas fa-th-list"></i> Seat Matrix for {{ train_name }}</h1>

        <div class="date-header">
            <h2><i class="fas fa-calendar-alt"></i> Journey Date: {{ date }}</h2>
            <p><i class="fas fa-circle-info"></i> Showing only seat types with available seats.</p>
        </div>

        {% for seat_type in seat_types %}
        {% if has_data_map[seat_type] %}
        {% set matrix = fare_matrices[seat_type] %}
        <div class="matrix-card">
            <h3><i class="fas fa-chair"></i> Seat Type: {{ seat_type }}</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>From → To</th>
                            {% for col in stations %}<th>{{ col }}</th>{% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for from_station in stations %}
                        <tr>
                            <td><strong>{{ from_station }}</strong></td>
                            {% for to_station in stations %}
                            {% if stations.index(from_station) >= stations.index(to_station) %}
                            <td class="disabled-cell"></td>
                            {% else %}
                            {% set cell = matrix[from_station].get(to_station) %}
                            {% if cell and (cell.online + cell.offline) > 0 %}
                            <td class="available">
                                <div class="cell-content">
                                    <span class="seat-count">{{ cell.online + cell.offline }}</span>
                                    <span class="fare"><span class="taka-icon">৳</span><span class="fare-value">{{
                                            (cell.fare + cell.vat_amount) | int }}</span></span>
                                    <a href="https://eticket.railway.gov.bd/booking/train/search?fromcity={{ from_station }}&tocity={{ to_station }}&doj={{ date }}&class={{ seat_type }}"
                                        class="buy-link" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Buy
                                    </a>
                                </div>
                            </td>
                            {% else %}
                            <td class="disabled-cell"></td>
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% endfor %}

        <a href="/" class="btn-primary">
            <i class="fas fa-arrow-left"></i> Back to Home
        </a>
    </div>
    <script src="/static/js/script.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const tables = document.querySelectorAll(".table-responsive");

            tables.forEach(table => {
                let isDown = false;
                let startX;
                let startY;
                let scrollLeft;
                let scrollTop;

                table.addEventListener("mousedown", (e) => {
                    isDown = true;
                    table.classList.add("dragging");
                    startX = e.pageX - table.offsetLeft;
                    startY = e.pageY - table.offsetTop;
                    scrollLeft = table.scrollLeft;
                    scrollTop = table.scrollTop;
                    e.preventDefault();
                });

                table.addEventListener("mouseleave", () => {
                    isDown = false;
                    table.classList.remove("dragging");
                });

                table.addEventListener("mouseup", () => {
                    isDown = false;
                    table.classList.remove("dragging");
                });

                table.addEventListener("mousemove", (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - table.offsetLeft;
                    const y = e.pageY - table.offsetTop;
                    const walkX = (x - startX);
                    const walkY = (y - startY);
                    table.scrollLeft = scrollLeft - walkX;
                    table.scrollTop = scrollTop - walkY;
                });
            });
        });
    </script>
</body>

</html>