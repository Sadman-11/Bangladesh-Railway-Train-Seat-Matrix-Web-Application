<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix | Segmented Seat Matrix</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon"
        href="https://raw.githubusercontent.com/nishatrhythm/Bangladesh-Railway-Train-and-Fare-List-with-Route-Map/main/images/bangladesh-railway.png">
</head>

<body>
    <div class="matrix-container">
        <h1><i class="fas fa-th-list"></i> Seat Matrix for {{ train_name }}</h1>

        <div class="date-header">
            <h2><i class="fas fa-calendar-alt"></i> Journey Date: {{ date }}</h2>
            <p><i class="fas fa-circle-info"></i> Showing only seat types with available seats.</p>
        </div>

        <div class="route-card route-visualization-card">
            <details class="route-collapse">
                <summary class="route-toggle-btn">
                    <span class="route-toggle-text"><i class="fas fa-route"></i> Expand to view Train Route</span>
                    <i class="fas fa-chevron-down toggle-arrow"></i>
                </summary>

                <div class="route-body">
                    <div class="route-train-header">
                        <h3><i class="fas fa-subway"></i> {{ train_name }}</h3>
                        <div class="run-days-list">
                            <span class="run-days-title">Runs on:</span>
                            {% for day in ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'] %}
                            <span class="run-day {% if day not in days %}off{% endif %}">
                                {{ day }}{% if day not in days %}<sup>(off)</sup>{% endif %}
                            </span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="station-timeline">
                        {% for stop in routes %}
                        <div class="station-item {% if loop.first %}start{% elif loop.last %}end{% endif %}">
                            <div class="station-node">
                                <div class="station-icon-circle">
                                    <i class="fas fa-location-dot"></i>
                                </div>
                                {% if not loop.last %}
                                <div class="station-line"></div>
                                {% endif %}
                            </div>
                            <div class="station-info">
                                <div class="station-header">
                                    <div class="station-name">
                                        {{ stop.city }}
                                        {% if stop.display_date %}
                                        <span class="station-date">{{ stop.display_date }}</span>
                                        {% endif %}
                                    </div>
                                    {% if loop.first %}
                                    <span class="station-type-label start">Start</span>
                                    {% elif loop.last %}
                                    <span class="station-type-label end">End</span>
                                    {% endif %}
                                </div>
                                <div class="station-meta-row">
                                    <div class="meta-item">
                                        <strong>Arrival:</strong>
                                        {% if stop.arrival_time %}
                                        {{ stop.arrival_time.replace(' BST', '') }}
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>

                                    <div class="meta-item">
                                        <strong>Departure:</strong>
                                        {% if stop.departure_time %}
                                        {{ stop.departure_time.replace(' BST', '') }}
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>

                                    <div class="meta-item">
                                        <strong>Halt:</strong>
                                        {% if stop.halt and stop.halt != '---' %}
                                        {{ stop.halt|int }} min
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>

                                    <div class="meta-item">
                                        <strong>Duration:</strong>
                                        {% if stop.duration and stop.duration != '---' %}
                                        {% set hours, minutes = stop.duration.split(':') %}
                                        {% set h = hours|int %}
                                        {% set m = minutes|int %}
                                        {% if h > 0 and m > 0 %}
                                        {{ h }} h {{ m }} min
                                        {% elif h > 0 %}
                                        {{ h }} h
                                        {% elif m > 0 %}
                                        {{ m }} min
                                        {% else %}
                                        ———
                                        {% endif %}
                                        {% else %}
                                        ———
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="total-journey-time">
                        <i class="fas fa-clock"></i> Total Duration:
                        {% if total_duration %}
                        {% set hours, minutes = total_duration.split(':') %}
                        {% set h = hours|int %}
                        {% set m = minutes|int %}
                        {% if h > 0 and m > 0 %}
                        {{ h }} h {{ m }} min
                        {% elif h > 0 %}
                        {{ h }} h
                        {% else %}
                        {{ m }} min
                        {% endif %}
                        {% else %}
                        ———
                        {% endif %}
                    </div>
                </div>
            </details>
        </div>

        {% for seat_type in seat_types %}
        {% if has_data_map[seat_type] %}
        {% set matrix = fare_matrices[seat_type] %}
        <div class="matrix-card">
            <h3><i class="fas fa-chair"></i> Seat Type: {{ seat_type }}</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>From → To</th>
                            {% for col in stations %}<th>{{ col }}</th>{% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for from_station in stations %}
                        <tr>
                            <td><strong>{{ from_station }}</strong></td>
                            {% for to_station in stations %}
                            {% if stations.index(from_station) >= stations.index(to_station) %}
                            <td class="disabled-cell"></td>
                            {% else %}
                            {% set cell = matrix[from_station].get(to_station) %}
                            {% if cell and (cell.online + cell.offline) > 0 %}
                            <td class="available">
                                <div class="cell-content">
                                    <span class="seat-count">{{ cell.online + cell.offline }}</span>
                                    <span class="fare"><span class="taka-icon">৳</span><span class="fare-value">{{
                                            (cell.fare + cell.vat_amount) | int }}</span></span>
                                    <a href="https://eticket.railway.gov.bd/booking/train/search?fromcity={{ from_station }}&tocity={{ to_station }}&doj={{ date }}&class={{ seat_type }}"
                                        class="buy-link" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Buy
                                    </a>
                                </div>
                            </td>
                            {% else %}
                            <td class="disabled-cell"></td>
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% endfor %}

        <a href="/" class="btn-primary">
            <i class="fas fa-arrow-left"></i> Back to Home
        </a>
    </div>
    <script src="/static/js/script.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const tables = document.querySelectorAll(".table-responsive");

            tables.forEach(table => {
                let isDown = false;
                let startX;
                let startY;
                let scrollLeft;
                let scrollTop;

                table.addEventListener("mousedown", (e) => {
                    isDown = true;
                    table.classList.add("dragging");
                    startX = e.pageX - table.offsetLeft;
                    startY = e.pageY - table.offsetTop;
                    scrollLeft = table.scrollLeft;
                    scrollTop = table.scrollTop;
                    e.preventDefault();
                });

                table.addEventListener("mouseleave", () => {
                    isDown = false;
                    table.classList.remove("dragging");
                });

                table.addEventListener("mouseup", () => {
                    isDown = false;
                    table.classList.remove("dragging");
                });

                table.addEventListener("mousemove", (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - table.offsetLeft;
                    const y = e.pageY - table.offsetTop;
                    const walkX = (x - startX);
                    const walkY = (y - startY);
                    table.scrollLeft = scrollLeft - walkX;
                    table.scrollTop = scrollTop - walkY;
                });
            });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const details = document.querySelector(".route-collapse");
            const textSpan = details.querySelector(".route-toggle-text");
            const icon = details.querySelector(".toggle-arrow");

            const updateText = () => {
                if (details.open) {
                    textSpan.innerHTML = '<i class="fas fa-route"></i> Collapse to hide Train Route';
                    icon.style.transform = "rotate(180deg)";
                } else {
                    textSpan.innerHTML = '<i class="fas fa-route"></i> Expand to view Train Route';
                    icon.style.transform = "rotate(0deg)";
                }
            };

            updateText();

            details.addEventListener("toggle", updateText);
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const detailsElements = document.querySelectorAll('.route-visualization-card details');

            detailsElements.forEach(details => {
                const toggleBtn = details.querySelector('.route-toggle-btn');
                const routeBody = details.querySelector('.route-body');

                const updateContentHeight = () => {
                    routeBody.style.height = 'auto';
                    const height = routeBody.scrollHeight;
                    routeBody.style.height = details.open ? `${height}px` : '0';
                    return height;
                };

                requestAnimationFrame(() => {
                    if (details.open) {
                        routeBody.style.height = `${updateContentHeight()}px`;
                        routeBody.style.opacity = '1';
                    }
                });

                toggleBtn.addEventListener('click', (e) => {
                    e.preventDefault();

                    if (details.hasAttribute('open')) {
                        routeBody.style.height = `${routeBody.scrollHeight}px`;
                        requestAnimationFrame(() => {
                            routeBody.style.height = '0';
                            routeBody.style.opacity = '0';
                        });
                        setTimeout(() => {
                            details.removeAttribute('open');
                        }, 400);
                    } else {
                        details.setAttribute('open', '');
                        routeBody.style.height = '0';
                        routeBody.style.opacity = '0';
                        requestAnimationFrame(() => {
                            const height = routeBody.scrollHeight;
                            routeBody.style.height = `${height}px`;
                            routeBody.style.opacity = '1';
                        });
                        setTimeout(() => {
                            routeBody.style.height = 'auto';
                        }, 400);
                    }
                });
                window.addEventListener('resize', () => {
                    if (details.open) {
                        routeBody.style.height = 'auto';
                        routeBody.style.height = `${routeBody.scrollHeight}px`;
                    }
                });
            });
        });
    </script>
</body>

</html>